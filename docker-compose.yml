# Все данные хранятся в локальных директориях проекта

networks:
  demo:

# ===========================================
# Docling Base Configuration (YAML Anchor)
# ===========================================
x-docling: &service-docling
  image: ghcr.io/docling-project/docling-serve:main
  container_name: docling
  networks: ['demo']
  restart: unless-stopped
  # Run as root to fix bind mount permissions on Windows
  user: root
  # Override working directory so referenced images are saved to shared folder
  working_dir: /shared/docling-scratch
  expose:
    - 5001/tcp
  ports:
    - 5001:5001
  environment:
    - DOCLING_SERVE_ENABLE_UI=true
    # Store extracted images in shared folder accessible by other services
    - DOCLING_SERVE_SCRATCH_PATH=/shared/docling-scratch
    # Keep results after retrieval so other services can access them
    - DOCLING_SERVE_SINGLE_USE_RESULTS=false
    # Gradio security: allow writing to /shared directory
    - GRADIO_ALLOWED_PATHS=/shared
    - GRADIO_TEMP_DIR=/shared/docling-scratch
    - DOCLING_SERVE_ENABLE_REMOTE_SERVICES=true
  volumes:
    - ./data/docling:/data
    - ./shared:/shared
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:5001/health"]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 60s

services:
  postgres:
    image: postgres:16-alpine
    hostname: postgres
    networks: ['demo']
    restart: unless-stopped
    environment:
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - POSTGRES_DB
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -h localhost -U ${POSTGRES_USER} -d ${POSTGRES_DB}']
      interval: 5s
      timeout: 5s
      retries: 10

  # ===========================================
  # Apache Kafka - Event Streaming Platform
  # ===========================================
  # Message broker and event streaming platform
  # Accessible at localhost:9092 (from host) and kafka:9093 (from containers)
  # UI accessible at http://localhost:8081 (kafka-ui)
  kafka:
    image: apache/kafka:3.8.1
    hostname: kafka
    container_name: kafka
    networks: ['demo']
    restart: unless-stopped
    ports:
      - 9092:9092
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_NUM_NETWORK_THREADS: 3
      KAFKA_NUM_IO_THREADS: 8
      KAFKA_LOG_RETENTION_HOURS: 168
    volumes:
      - ./data/kafka:/var/lib/kafka/data
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 9092 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ===========================================
  # Kafka UI - Web Interface for Kafka
  # ===========================================
  # Web-based UI for managing and monitoring Kafka
  # Accessible at http://localhost:8081
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    hostname: kafka-ui
    container_name: kafka-ui
    networks: ['demo']
    restart: unless-stopped
    ports:
      - 8081:8080
    environment:
      - KAFKA_CLUSTERS_0_NAME=local
      - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka:9092
      - DYNAMIC_CONFIG_ENABLED=true
    depends_on:
      kafka:
        condition: service_healthy

  # ===========================================
  # MinIO - S3-Compatible Object Storage
  # ===========================================
  # High-performance object storage server
  # Console UI accessible at http://localhost:9001
  # API accessible at http://localhost:9000
  minio:
    image: minio/minio:latest
    hostname: minio
    container_name: minio
    networks: ['demo']
    restart: unless-stopped
    ports:
      - 9000:9000  # API
      - 9001:9001  # Console
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
      - MINIO_BROWSER_REDIRECT_URL=http://localhost:9001
    command: server /data --console-address ":9001"
    volumes:
      - ./data/minio:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ===========================================
  # MinIO Client - Create default bucket
  # ===========================================
  # Initializes MinIO with default bucket on first run
  minio-init:
    image: minio/mc:latest
    container_name: minio-init
    networks: ['demo']
    entrypoint: /bin/sh
    command:
      - "-c"
      - |
        sleep 5
        mc alias set minio http://minio:9000 ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD}
        mc mb minio/ai-data --ignore-existing
        mc mb minio/models --ignore-existing
        mc mb minio/documents --ignore-existing
        echo "MinIO buckets initialized"
    depends_on:
      minio:
        condition: service_healthy

  qdrant:
    image: qdrant/qdrant
    hostname: qdrant
    container_name: qdrant
    networks: ['demo']
    restart: unless-stopped
    ports:
      - 6333:6333
    volumes:
      - ./data/qdrant:/qdrant/storage

  # ===========================================
  # Neo4j - Graph Database
  # ===========================================
  # Graph database for knowledge graphs and connected data
  # Browser UI accessible at http://localhost:7474
  # Bolt protocol at bolt://localhost:7687
  neo4j:
    image: neo4j:5.15-community
    hostname: neo4j
    container_name: neo4j
    networks: ['demo']
    restart: unless-stopped
    ports:
      - 7474:7474  # HTTP (Browser UI)
      - 7687:7687  # Bolt protocol
    environment:
      - NEO4J_AUTH=${NEO4J_USER}/${NEO4J_PASSWORD}
      - NEO4J_ACCEPT_LICENSE_AGREEMENT=yes
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=2G
      - NEO4J_dbms_memory_pagecache_size=512m
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*
      - NEO4JLABS_PLUGINS=["apoc"]
    volumes:
      - ./data/neo4j/data:/data
      - ./data/neo4j/logs:/logs
      - ./data/neo4j/import:/var/lib/neo4j/import
      - ./data/neo4j/plugins:/plugins
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u ${NEO4J_USER} -p ${NEO4J_PASSWORD} 'RETURN 1'"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ===========================================
  # Static File Server - Serves shared folder
  # ===========================================
  # Access files at http://localhost:8080/
  # Example: http://localhost:8080/extracted-images/image_xxx.png
  static-files:
    image: nginx:alpine
    hostname: static-files
    container_name: static-files
    networks: ['demo']
    restart: unless-stopped
    ports:
      - 8080:80
    volumes:
      - ./shared/extracted-images:/usr/share/nginx/html:ro
    command: |
      sh -c "echo 'server {
        listen 80;
        root /usr/share/nginx/html;
        index chat.html;
        autoindex on;
        location / {
          try_files \$$uri \$$uri/ =404;
          add_header Access-Control-Allow-Origin *;
        }
      }' > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"

  # ===========================================
  # Docling - Document Processing
  # ===========================================
  # OCR and document parsing service
  # Accessible at http://localhost:5001
  # Uses profiles: cpu, gpu-nvidia, gpu-amd
  # Docs: https://github.com/docling-project/docling-serve

  docling-cpu:
    profiles: ["cpu"]
    <<: *service-docling

  docling-gpu:
    profiles: ["gpu-nvidia"]
    <<: *service-docling
    image: ghcr.io/docling-project/docling-serve-cu126:main
    environment:
      - DOCLING_SERVE_ENABLE_UI=true
      - DOCLING_SERVE_SCRATCH_PATH=/shared/docling-scratch
      - DOCLING_SERVE_SINGLE_USE_RESULTS=false
      - GRADIO_ALLOWED_PATHS=/shared
      - GRADIO_TEMP_DIR=/shared/docling-scratch
      - NVIDIA_VISIBLE_DEVICES=all
      - DOCLING_SERVE_ENABLE_REMOTE_SERVICES=true
    runtime: nvidia

  docling-gpu-amd:
    profiles: ["gpu-amd"]
    <<: *service-docling
    image: ghcr.io/docling-project/docling-serve-rocm:main
    environment:
      - DOCLING_SERVE_ENABLE_UI=true
      - DOCLING_SERVE_SCRATCH_PATH=/shared/docling-scratch
      - DOCLING_SERVE_SINGLE_USE_RESULTS=false
      - GRADIO_ALLOWED_PATHS=/shared
      - GRADIO_TEMP_DIR=/shared/docling-scratch
      - ROCR_VISIBLE_DEVICES=0
      - DOCLING_SERVE_ENABLE_REMOTE_SERVICES=true
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri
    group_add:
      - 44    # video group GID (run: getent group video)
      - 109   # render group GID (run: getent group render)
